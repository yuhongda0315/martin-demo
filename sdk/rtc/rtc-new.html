<!DOCTYPE html>

<head>
  <meta charset="UTF-8">
  <title>RongRTC</title>
  <link rel="stylesheet" href="../css/common.css">
  <script src="http://10.12.9.185:8686/web-sdk-v2/release/2.3.6/protobuf-2.3.4.min.js?1223"></script>
  <script src="http://10.12.9.185:8686/web-sdk-v2/dist/RongIMLib.js?13"></script>
  <script src="http://10.12.9.185:8686/web-rtc-sdk/dist/RongRTC.3.0.0.js?12"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: #000;
    }

    .rong-container {
      height: 90%;
    }

    .rong-toolbar {
      height: 240px;
      border-bottom: 1px solid #FFF;
      box-sizing: border-box;
      padding: 10px;
      width: 80%;
    }

    .rong-video-box {
      height: 80%;
    }

    .rong-input {
      outline: none;
      background: none;
      color: #FFF;
      cursor: pointer;
      line-height: 16px;
      border-radius: 5px;
      padding: 4px;
    }

    .rong-input:hover {
      background-color: #FFF;
      color: #333;
      transition: 0.8s;
    }

    .rong-video-child {
      background: #000;
      opacity: 0.9;
      color: #FFF;
      text-align: center;
      display: none;
      line-height: 100px;
    }

    .rong-video-box .rong-video-child,
    video {
      height: 100px;
      width: 100px;
      margin: 20px;
      float: left;
      border: 1px solid #FFF;
      position: absolute;
    }

    .rong-video {
      position: relative;
      float: left;
      height: 100px;
      width: 100px;
      margin-right: 20px;
    }

    .rong-video-srouce {
      border-top: 1px solid #FFF;
      position: absolute;
      width: 80%;
      height: 100px;
      left: 0;
      bottom: 40px;
    }

    .rong-video-srouce video {
      height: 100px;
    }

    .input-token {
      width: 80%;
    }

    .rong-logs {
      height: 100%;
      width: 20%;
      color: #FFF;
      position: absolute;
      top: 0;
      right: 0;
      border-left: 1px solid #FFF;
      z-index: 99;
      overflow-y: auto;
    }

    pre {
      border: none;
    }

    .rong-buttons-room,
    .rong-buttons-stream,
    .rong-buttons-operation {
      display: block;
    }
  </style>
  <script src="./config.js"></script>
</head>

<body>

  <div class="rong-container">
    <div class="rong-toolbar">
      <input type="text" value="c9kqb3rdkbb8j" placeholder="appkey" id="appkey" class="input-content">
      <input type="text" value="navqa.cn.ronghub.com" placeholder="nav" id="nav">
      <!-- <input type="text" value="e0x9wycfx7flq" placeholder="appkey" id="appkey" class="input-content"> -->
      <!-- <input type="text" value="navxq.rongcloud.net" placeholder="nav" id="nav"> -->
      <!-- <br /> -->
      <div class="rong-buttons-connect">
        <input class="rong-input" type="button" value="Connect" onclick="connect()">
      </div>
      <div class="rong-buttons-room">
        <input class="rong-input" type="button" value="Join" onclick="joinRoom()">
        <input class="rong-input" type="button" value="Leave" onclick="leaveRoom()">
      </div>
      <div class="rong-buttons-stream">
        <input class="rong-input" type="button" value="publishMP4" onclick="publishMP4()">
        <input class="rong-input" type="button" value="unpublishMP4" onclick="unpublishMP4()">
        <input class="rong-input" type="button" value="publishCamera" onclick="publishCamera()">
        <input class="rong-input" type="button" value="unpublishCamera" onclick="unpublishCamera()">
        <input class="rong-input" type="button" value="publishMulti" onclick="publishMulti()">
        <input class="rong-input" type="button" value="unpublishMulti" onclick="unpublishMulti()">
      </div>
      <div class="rong-buttons-operation">
        <input class="rong-input" type="button" value="Mute" onclick="mute()">
        <input class="rong-input" type="button" value="Unmute" onclick="unmute()">
        <input class="rong-input" type="button" value="DisbaleVideo" onclick="disableVideo()">
        <input class="rong-input" type="button" value="EnableVideo" onclick="enableVideo()">
        <input class="rong-input" type="button" value="resizeStream" onclick="resizeStream()">
        <input class="rong-input" type="button" value="GetStream" onclick="getStream()">
      </div>
    </div>
    <div class="rong-video-box">
    </div>
    <div class="rong-video-srouce">
      <video id="source" src="./heal-the-world.mp4" controls></video>
    </div>
    <div class="rong-logs" id="rong-logs"></div>
  </div>

  <script src="../js/init.js?123"></script>
  <script src="../js/utils.js?123"></script>
  <script>
    var Rong = null;
    var utils = RCUtils.utils;
    var conversation = RCUtils.conversation;
    var Log = RCUtils.Log;

    var log = new Log({
      element: utils.getDom('rong-logs')
    });

    function clearResult() {
      log.clear();
    }
    function getAppInfo() {
      let queryString = location.search.split('?')[1] || 0;
      let querys = queryString.split('&');
      let info = {};
      for (let i = 0; i < querys.length; i++) {
        let query = querys[i];
        let [key, value] = query.split('=');
        info[key] = value;
      }
      return info;
    }
    let app = getAppInfo();
    // let tokens = {
    //   mon9900: 'yNsh6/3ujm6RQGK6MQ/j0/8d3dyrkUjx04znTXDsPzzpNDJX9spyaukAngIwvKZFYAMFyq8aKX09uDjU1oB29oLPgPfFBJHe',
    //   mon9901: 'prH8uzRILrGYXUZ7qVlxRwpRCpGrPzwCFuGMdWXYpP7HqNp27QlOgBA6rETRwO6Gm1bui6sxnhrPaeM8QnCw2qcJF/wOnBc4',
    //   mon9902: 'HeYpdMrd+/IekQY8eBro0t8RUjg9Uz4w00XN+PnPvCfmeIaMXa5q3M1GljJr1am+gbDvOnuUyYXg8V4oKC9u9Q==',
    //   mon9903: 'mvlggHVmRB/jhgR/cyVvkP8d3dyrkUjx04znTXDsPzzpNDJX9spyavao8PPooMpA9JdnyFKAyGtdQZQKRFBapoLPgPfFBJHe',
    //   mon9904: 'ss8A44xvrJhvtaEXj1Cmpf8d3dyrkUjx04znTXDsPzzpNDJX9spyatAN5Ixm6oQ7v1c1WMNIrhL6nPD8bL7BkYLPgPfFBJHe',
    //   web001: 'ubobp2MGnYvaIE8HRo+xTApRCpGrPzwCFuGMdWXYpP4WzyoeiDeGOanLFM9WjLvGjUtK7Wk6BFsI040sOf+LSw==',
    //   web002: 'A8UTlUYXnrjBZySi9FvHst8RUjg9Uz4w00XN+PnPvCc9f/g7z/nKphA2pVxWMReCfbwh3el5YQvVmD5XsQ4p8A==',
    //   web003: 'xffPNaX3+sJ3pk6yWOLSo98RUjg9Uz4w00XN+PnPvCc9f/g7z/nKpmWEpG2/iDEzfbwh3el5YQudJk+e3r8eOQ==',
    //   web004: 'IgReKd/Hgix3pk6yWOLSo98RUjg9Uz4w00XN+PnPvCc9f/g7z/nKphAxQ3/z547Sfbwh3el5YQuisyOS/r3ZEA=='
    // };

    let currentUser = {
      id: app.userId,
      token: '',
      roomId: app.roomId
    }
    function connect() {
      if (Rong) {
        return;
      }

      getToken(currentUser).then(response => {
        var result = response.result;
        var token = result.token;
        var appkey = utils.getDom('appkey').value;
        var navi = utils.getDom('nav').value;

        var params = {
          appkey: appkey,
          token: token,
          navi: navi
        };
        var callbacks = {
          connected: function (_Rong) {
            Rong = _Rong;
            log.show('Connect', 'connect successfully');
          },
          disconnectd: function () {
            Rong = null;
          },
          received: function (message) {
            log.show('Received Message', message);
          }
        };
        init(params, callbacks);
      });
    }

    var getToken = function (user) {
      let url = config.url;
      return fetch(url, {
        method: 'POST',
        body: JSON.stringify({
          id: user.id
        }),
        headers: {
          'Content-Type': 'application/json; charset=UTF-8'
        }
      }).then(response => response.json());
    };
    let getDom = (key) => {
      return document.querySelector(key);
    };
    let videoBox = getDom('.rong-video-box');
    let createDiv = (id, classList) => {
      let node = document.createElement('div');
      node.id = id;
      node.classList = classList;
      return node;
    };
    let getId = (user, suffix) => {
      let { stream: { tag }, id } = user;
      let key = id + '_' + tag;
      if (suffix) {
        key += '_' + suffix;
      }
      return key;
    };
    let appendVideo = (user) => {
      let { stream: streams } = user;
      if (Object.prototype.toString.call(streams) != '[object Array]') {
        streams = [streams];
      }
      let ms = streams.filter((ms) => {
        return ms.size != StreamSize.MIN;
      })[0];
      let { mediaStream } = ms;
      let video = createVideo(mediaStream);
      let userInfo = {
        id: user.id,
        stream: ms
      };
      let id = getId(userInfo);
      let box = createDiv(id, ['rong-video']);
      let childId = getId(userInfo, 'info');
      let child = createDiv(childId, ['rong-video-child'])
      box.appendChild(video);
      box.appendChild(child);
      videoBox.appendChild(box);
    };
    let removeVideo = (user) => {
      let { stream: { tag }, id } = user;
      let video = getDom('#' + id + '_' + tag);
      if (video) {
        videoBox.removeChild(video);
      }
    };
    let rongRTC = new RongRTC({
      // url: 'http://10.13.10.117:7788/',
      // url: 'http://msqa.rongcloud.net',
      RongIMLib: RongIMLib,
      // debug: true,
      created: function () {
        console.log('RongRTC:created');
      },
      mounted: function () {
        console.log('RongRTC:mounted');
      },
      unmounted: function () {
        console.log('RongRTC:unmounted');
      },
      destroyed: function () {
        console.log('RongRTC:destroyed');
      },
      logger: function (log) {
        console.log(log);
      }
    });
    let { Room, Stream, StreamType, StreamSize } = rongRTC;

    let room = new Room({
      id: currentUser.roomId,
      joined: function (user) {
        log.show('', `${user.id} 加入房间`);
      },
      left: function (user) {
        log.show('', `${user.id} 离开房间`);
      }
    });

    let showTip = (user, style, tip) => {
      let id = getId(user, 'info');
      let node = getDom('#' + id);
      node.style.display = style;
      node.innerHTML = tip;
    };
    let stream = new Stream({
      published: function (user) {
        user.stream.type = StreamType.AUDIO_AND_VIDEO;
        stream.subscribe(user).then(user => {
          appendVideo(user);
        });
      },
      unpublished: function (user) {
        stream.unsubscribe(user);
        removeVideo(user);
      },
      muted: function (user) {
        console.log('muted', user);
        showTip(user, 'block', 'Muted');
      },
      unmuted: function (user) {
        console.log('unmuted', user);
        showTip(user, 'none', 'Unmuted');
      },
      disabled: function (user) {
        console.log('disabled', user);
        showTip(user, 'block', 'Disabled');
      },
      enabled: function (user) {
        console.log('enabled', user);
        showTip(user, 'none', 'Enabled');
      }
    });

    function joinRoom() {
      room.join({
        id: currentUser.id,
        token: currentUser.id
      }).then(() => {
        log.show('', 'join successfully');
      }, error => {
        log.show('', error);
      });
    }

    function leaveRoom() {
      room.leave().then((user) => {
        videoBox.innerHTML = '';
        log.show('', 'leave successfully');
      }, (error) => {
        log.show('', error);
      });
    }
    let createVideo = (stream) => {
      let video = document.createElement('video');
      video.srcObject = stream;
      video.autoplay = true;
      return video;
    };

    function getStream() {
      stream.get({
        id: currentUser.id,
        stream: {
          tag: 'mp4'
        }
      }).then(stream => {
        console.log(stream);
      }, error => {
        log.show('', error);
      });
    }
    function getMedia(callback) {
      navigator.getUserMedia({ video: true, audio: true }, function (stream) {
        callback(stream);
        appendVideo({
          id: currentUser.id,
          stream: {
            tag: 'rtc',
            mediaStream: stream
          }
        });
      }, error => {
        log.show('', error);
      })
    }
    function publishMP4() {
      var sourceNode = document.querySelector('#source');
      var mediaStream = sourceNode.captureStream();
      let user = {
        id: currentUser.id,
        stream: [{
          type: StreamType.AUDIO_AND_VIDEO,
          tag: 'mp4',
          mediaStream: mediaStream
        }]
      };
      stream.publish(user).then(() => {
        log.show('', 'publish successfully.');
        appendVideo(user);
      }, error => {
        log.show('', error);
      });
    }

    function unpublishMP4() {
      let user = {
        id: currentUser.id,
        stream: {
          type: StreamType.AUDIO_AND_VIDEO,
          tag: 'mp4'
        }
      };
      stream.unpublish(user).then(() => {
        removeVideo(user);
        log.show('', 'unpublish successfully.')
      }, error => {
        log.show('', error);
      })
    }

    function publishCamera() {
      getMedia(function (mediaStream) {
        stream.publish({
          id: currentUser.id,
          stream: {
            type: StreamType.AUDIO_AND_VIDEO,
            tag: 'rtc',
            mediaStream: mediaStream
          }
        }).then(() => {
          log.show('', 'publish successfully.')
        }, error => {
          log.show('', error);
        })
      });
    }
    function unpublishCamera() {
      let user = {
        id: currentUser.id,
        stream: {
          tag: 'rtc',
          type: StreamType.AUDIO_AND_VIDEO
        }
      };
      stream.unpublish(user).then(() => {
        log.show('', 'unpublish successfully.')
        removeVideo(user);
      }, error => {
        log.show('', error);
      });
    }

    function publishMulti() {
      var sourceNode = document.querySelector('#source');
      var videoStream = sourceNode.captureStream();
      getMedia(function (mediaStream) {
        stream.publish({
          id: currentUser.id,
          stream: [{
            type: StreamType.AUDIO_AND_VIDEO,
            tag: 'rtc',
            mediaStream: videoStream,
            size: StreamSize.MAX
          }, {
            type: StreamType.AUDIO_AND_VIDEO,
            tag: 'rtc',
            mediaStream: mediaStream,
            size: StreamSize.MIN
          }]
        }).then(() => {
          log.show('', 'publishMulti successfully.')
        }, error => {
          log.show('', error);
        })
      });
    }

    function unpublishMulti() {
      let user = {
        id: currentUser.id,
        stream: {
          tag: 'rtc',
          type: StreamType.AUDIO_AND_VIDEO
        }
      };
      stream.unpublish(user).then(() => {
        log.show('', 'unpublishMulti successfully.')
        removeVideo(user);
      }, error => {
        log.show('', error);
      });
    }
    let isMax = false;
    function resizeStream() {
      let { StreamType } = rongRTC;
      isMax = !isMax;
      let user = {
        id: 'web001',
        stream: {
          tag: 'rtc',
          type: 1,
          size: isMax ? StreamSize.MAX : StreamSize.MIN
        }
      };
      stream.resize(user).then(() => {
        log.show('', '切换成功, 当前为 ' + isMax ? '大' : '小' + ' 流');
      }, error => {
        log.show('', error);
      });
    }

    function mute() {
      var user = {
        id: currentUser.id,
        stream: {
          tag: 'mp4'
        }
      };
      stream.audio.mute(user).then(() => {
        log.show('', '已静音');
        showTip(user, 'block', 'Muted');
      }, error => {
        log.show('', error);
      });
    }

    function unmute() {
      var user = {
        id: currentUser.id,
        stream: {
          tag: 'mp4'
        }
      };
      stream.audio.unmute(user).then(() => {
        log.show('', '已取消静音');
        showTip(user, 'none', 'Unmuted');
      }, error => {
        log.show('', error);
      });;
    }

    function disableVideo() {
      var user = {
        id: currentUser.id,
        stream: {
          tag: 'mp4'
        }
      };
      stream.video.disable(user).then(() => {
        log.show('', '视频已禁用');
        showTip(user, 'block', 'Disabled');
      }, error => {
        log.show('', error);
      });;
    }

    function enableVideo() {
      var user = {
        id: currentUser.id,
        stream: {
          tag: 'mp4'
        }
      };
      stream.video.enable(user).then(() => {
        log.show('', '视频已启用');
        showTip(user, 'none', 'Enabled');
      }, error => {
        log.show('', error);
      });;
    }
  </script>
</body>

</html>