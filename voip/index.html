<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title> Super </title>
    <style>
        .input{
            margin-left: 30px;
        }
        .video-main{
            width: 50%;
            height: 500px;
            border: 1px solid gray;
            float: left;
        }
        .video-main video{
            height: inherit;
        }

        .video-box{
            width: 40%;
            height: 500px;
            float: right;
            overflow-y: auto;
            border: 1px solid gray;
        }
        .voide-child{
            float:left;
            margin-left: 30px;
            margin-top: 5px;
            width: 200px;
            height: 150px;
            border: 2px solid gray;
        }

        .video-bar{
            float: right;
            margin-right: 10px;
            height: 20px;
            width: 20px;
        }

        .tool-bar{
            clear: both;
            padding: 20px;
        }
        .voide-child video{
            height: 125px;
            width: 200px;
        }
    </style>
</head>
<body>
    
    <div class="video-main"> </div>

    <div class="video-box"> </div>

    <div class="tool-bar">
        <input type="button" value="call" onclick="call()">
        <input type="button" value="hungup" onclick="hungup()">

        <input type="button" value="accept" onclick="acceptCall()">

        <input type="button" value="mute" onclick="mute()">
        <input type="button" value="unmute" onclick="unmute()">

        <input type="button" value="videoToAudio" onclick="videoToAudio()">
        <input type="button" value="audioToVideo" onclick="audioToVideo()">

    </div>

</body>

    <script src="//cdn.ronghub.com/RongIMLib-2.2.5.js"></script>
    <script src="init.js"></script>

    <script src="jquery-3.1.1.js"></script>
    
    <script src="./adapter.js"></script>
    <script src="./kurento-utils.js"></script>
    <script src="./kurento-jsonrpc.js"></script>
    <script src="./EventEmitter.js"></script>
    <script src="./KurentoRoom.js"></script>

    <script src="RongCallLib-webRTC.js"></script>
    <script src="rong-adapter.js"></script>

    <script>
       var users = [ {
                userid:"1001",
                token:"hsYEW1+K1JHASMHGUrJJJLrkPG6U/xPk3zvPIWf9le1hEGTTL55/U3+F/iaeDmXmOvEHh5CgU1f6tiN2qQZgBQ=="
            }, {
                userid:"1002",
                token:"UAFlOdMThtHnc18558yPhcSkAMimzaj6nB20cRPaYWRyLGGbEPHrt12ut6s/G81HNXcegD4ILRb/EnGJdxts4Q=="
            }];

        var userId = users[0].userid;
        var inviteUserIds = [users[1].userid];
        var token = users[0].token;
        var targetId = users[1].userid;

        if(location.search.indexOf("user") > -1){
            userId = users[1].userid;
            inviteUserIds = [users[0].userid];
            token = users[1].token;
            targetId = users[0].userid;
        }

        function onInitcomplete(error, callLib){
            console.log(callLib);
        }

        var sendMessage = function(params, callback){
            var conversationType = params.conversationType;
            var targetId = params.targetId;
            var msg = params.msg;

            var im = RongIMLib.RongIMClient.getInstance();

            im.sendMessage(conversationType, targetId, msg, {
                onSuccess: function(message) {
                    callback(null, message);
                },
                onError: function(code) {
                    callback(code);
                }
            });
        };

        var messageType = {
            AcceptMessage: RongIMLib.AcceptMessage,
            RingingMessage: RongIMLib.RingingMessage,
            SummaryMessage: RongIMLib.SummaryMessage,
            HungupMessage: RongIMLib.HungupMessage,
            InviteMessage: RongIMLib.InviteMessage,
            MediaModifyMessage: RongIMLib.MediaModifyMessage,
            MemberModifyMessage: RongIMLib.MemberModifyMessage
        };
        var message = {
            send: sendMessage,
            messageTypes: messageType
        };
        RongCallLib.message(message);

        var element = $('.video-main')[0];

        var config = {
            userId: userId,
            timeoutMillis: 30000,
            element: element,
            url: 'wss://111.200.55.12:8443/room',
            getElmentNode: function(){
                return {
                    parent: $('.video-box')[0],
                    child: $('<div class="voide-child"><div class="video-bar">x</div></div>')[0]
                };
            }
        };
        RongCallLib.config(config);  

        var callbacks = {
            getInstance : function(instance){
                // 连接成功后调用
                console.log(RongCallLib);
            },
            getCurrentUser : function(userInfo){
                console.log(userInfo.userId);
            },
            receiveNewMessage : function(message){
                console.log(message);
            }
        };

        var params = {
            appKey : '8luwapkvucoil',
            token : token
        };
        
        var mediaType = RongIMLib.MediaType;

        init(params,callbacks);   

        function call(){
            var params = {
                conversationType: 1,
                targetId: targetId,
                inviteUserIds: inviteUserIds
            };

            RongCallLib.call(params, function(error, result){
                console.log(error);
            });
        }

        function hungup(){
            var params = { };
            RongCallLib.hungup(params);
        }

        function acceptCall(){
            var params = {
                mediaType: mediaType.VIDEO
            };
            RongCallLib.accept(params);
        }

        function mute(){
            var params = {};
            RongCallLib.mute(params);
        }

        function unmute(){
            var params = {};
            RongCallLib.unmute(params);
        }

        function videoToAudio(){
            RongCallLib.videoToAudio(params);
        }

        function audioToVideo(){
            RongCallLib.audioToVideo(params);
        }

    </script>
</html> 