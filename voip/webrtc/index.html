<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="http://7xogjk.com1.z0.glb.clouddn.com/IuDkFprSQ1493563384017406982"/>
    <title id='pageTitle'> Super </title>
    <style>
        .input{
            margin-left: 30px;
        }
        .video-main{
            width: 40%;
            height: 500px;
            border: 1px solid gray;
            float: left;
        }
        .video-main video{
            width: 100%;
            height: inherit;
        }

        .video-box{
            width: 40%;
            height: 500px;
            float: right;
            overflow-y: auto;
            border: 1px solid gray;
        }
        .voide-child{
            float:left;
            margin-left: 30px;
            margin-top: 5px;
            width: 200px;
            height: 150px;
            border: 2px solid gray;
        }

        .video-bar{
            float: right;
            margin-right: 10px;
            height: 20px;
            width: 20px;
        }

        .tool-bar{
            clear: both;
            padding: 20px;
        }
        .voide-child video{
            height: 125px;
            width: 200px;
        }
    </style>
</head>
<body>
    
    <div class="video-main"> </div>

    <div class="video-box"> </div>

    <div class="tool-bar">
        <input type="button" value="call" onclick="call()">
        <input type="button" value="invite" onclick="invite()">
        <input type="button" value="hungup" onclick="hungup()">

        <input type="button" value="accept" onclick="acceptCall()">
        <input type="button" value="reject" onclick="reject()">
        
        <input type="button" value="mute" onclick="mute()">
        <input type="button" value="unmute" onclick="unmute()">

        <input type="button" value="videoToAudio" onclick="videoToAudio()">
        <input type="button" value="audioToVideo" onclick="audioToVideo()">

        <input type="button" value="startScreen" onclick="startScreen()">
        <input type="button" value="acceptScreen" onclick="acceptScreen()">
    </div>

    <!-- <script src="//cdn.ronghub.com/RongIMLib-2.2.5.js"></script> -->
    <script src="./RongIMLib.js"></script>
</body>

    <script src="../init.js"></script>

    <script src="../jquery-3.1.1.js"></script>
    
    <script src="./adapter.js"></script>
    <script src="./kurento-utils.js"></script>
    <script src="./kurento-jsonrpc.js"></script>
    <script src="./EventEmitter.js"></script>
    <script src="./KurentoRoom.js"></script>

    <script src="../underscore-1.8.3.js"></script>

    <script src="../rong-calllib-util.js"></script>
    <script src="./rong-calllib-webrtc.js"></script>

    <script src="../rong-calllib-sendmsg.js"></script>

    <script src="../rong-calllib.js"></script>

    <script>
       // var users = [ {
       //          userid:"1005",
       //          token:"h54Hq8SwoKv8ygREPE8Cl7rkPG6U/xPk3zvPIWf9le1hEGTTL55/U5viwcnHZo8BfZ/jYTR4aqJC1jg8FF1qjw=="
       //      }, {
       //          userid:"1006",
       //          token:"BIG85AHHpMAXYvnD2DSgnLrkPG6U/xPk3zvPIWf9le1hEGTTL55/U07yY3a+mzGazeB0RzEl9Y46MnCyDLVMAw=="
       //      }, {
       //          userid:"1001",
       //          token:"hsYEW1+K1JHASMHGUrJJJLrkPG6U/xPk3zvPIWf9le1hEGTTL55/U3+F/iaeDmXmOvEHh5CgU1f6tiN2qQZgBQ=="
       //      }];

        // var users = [ {
        //     userid:"xiaoqiao9901",
        //     token:"lkjMJKTLnHN4x2bHmpktSLywMGBz8rrOEvvIt6wnoWtS/djzTfE65mnnYm6hzGxOfWXuti0epkOS1BFuAUwiECvbaor53a5U"
        // }, {
        //     // userid:"xiaoqiao9902",
        //     // userid:"52dzNbLBZ",
        //     userid:"AUj8X32w1",
        //     token:"hZ/FYFCN0MRB/zUkNoG3j8Lg1HgVe6BNpEIHZDy7fhI1VRF7zfE/Qv7aE2aMdLAzhhkwCwiGcAwLZ2dp77Kizg=="
        // }];

        var users = [{
            userid:"bAQcDRwzTe8SUmDVN7yqdB",
            token:"KzpgQVDyx4DBSxRG8u1/4vwKeAiSMOZpgi96Mlxp6zVg2moPQK06A4SxrxnC7Kp9qXQXscEWxipbzaCGFNM6FA8AWZPjrly9yo5F0vKIcOUH6oUzxOCKMQ=="
        }, {
            userid:"MybNbLRog3Kjzz8H6DCE8M",
            token:"9ZXffJsmXpHb09CzO26oWnYNDAey+CFwhZPcG3x/Kb69AQzuRlokmuLzU/GbTEn7UX5dyWicowyvwaoCXshq2J6odO5/+ShE"
        }];


        var userId = users[0].userid;
        var inviteUserIds = [users[1].userid];
        var token = users[0].token;

        var conversationType = 1;
        var targetId = users[1].userid;

        if(location.search.indexOf("user") > -1){
            userId = users[1].userid;
            inviteUserIds = [users[0].userid];
            token = users[1].token;
            targetId = users[0].userid;
        }

         if(location.search.indexOf("user1") > -1){
            userId = users[2].userid;
            inviteUserIds = [users[0].userid];
            token = users[2].token;
            targetId = users[0].userid;
        }

        function onInitcomplete(error, callLib){
            console.log(callLib);
        }

        var callbacks = {
            getInstance : function(instance){
               
            },
            getCurrentUser : function(userInfo){
                console.log(userInfo.userId);
            }
        };

        var params = {
            appKey : 'pwe86ga5pwrj6',
            // appKey : 'e0x9wycfx7flq',
            // navi: '119.254.111.49:9100',
            token : token
        };
        
        var mediaType = RongIMLib.MediaType;

        QuickInit.init(params,callbacks);

/************************ WebRTC **************************************/
        // 大视频窗口
        var element = $('.video-main')[0];
        // video box
        var videoBox = $('.video-box')[0];
        var config = {
            currentUserId: userId,
            url: 'wss://119.254.101.80:38443/room'
        };
        RongCallLib.setConfig(config);  

        var clearChild = function() {
            videoBox.innerHTML = "";
            element.innerHTML = "";
        };

        var createVideo = function(id, src) {
            var video = document.createElement('video');
            video.id = 'main-' + id;
            video.autoplay = true;
            video.controls = false;
            video.src = src;
            return video;
        };

        var setMain = function(node) {
            var id = node.id;
            var src = node.src;
            var video = createVideo(id, src);
            element.innerHTML = "";
            element.appendChild(video);
        };

        var videoItem = {
            added: function(result){
                var node = result.data;

                var videoEl = $('<div class="voide-child"><div class="video-bar">x</div></div>')[0];
                videoEl.appendChild(node);
                videoBox.appendChild(videoEl);

                videoEl.onclick = function(){
                    setMain(node);
                };

                if (result.isLocal) {
                    // setMain(node);
                }
            },
            removed: function(result){
                var videoElId = result.data;
                var videoEl = $('#' + videoElId)[0];
                var parentEl = videoEl.parentNode;
                videoBox.removeChild(parentEl);
            }
        };
        // 注册视频节点监听
        RongCallLib.videoWatch(function(result){
            videoItem[result.type](result);
        });

        // 注册命令监听
        RongCallLib.commandWatch(function(command){
            console.warn(command);
        });


        var CallType = RongIMLib.VoIPMediaType;

        function call(){
            /*
                engineType : 
                    1: Agora
                    2: WebRTC
                    3: Blink
             */
            var params = {
                engineType: 2,
                conversationType: conversationType,
                targetId: targetId,
                inviteUserIds: inviteUserIds,
                mediaType: CallType.MEDIA_VEDIO
            };
            RongCallLib.call(params, function(error){
                console.log(error);
            });
        }

        function invite(){
            var targetId = '1001';
            
            var params = {
                conversationType: conversationType,
                targetId: targetId,
                inviteUserIds: [targetId],
                mediaType: CallType.MEDIA_VEDIO
            };
            RongCallLib.invite(params, function(error){
                console.log(error);
            });
        }

        function hungup(){
            clearChild();
            var params = {
                conversationType: conversationType,
                targetId: targetId,   
            };
            RongCallLib.hungup(params);
        }

        function acceptCall(){
            /*
                engineType : 
                    1: Agora
                    2: WebRTC
                    3: Blink
             */
            var params = {
                engineType: 2,
                conversationType: conversationType,
                targetId: targetId,
                mediaType: CallType.MEDIA_VEDIO
            };
            RongCallLib.accept(params);
        }

        function acceptScreen(){
            var params = {
                conversationType: conversationType,
                targetId: targetId,
                isSharing: true,
                mediaType: CallType.MEDIA_VEDIO
            };
            RongCallLib.accept(params);
        };

        function startScreen(){
            var params = {
                conversationType: conversationType,
                targetId: targetId,
                isSharing: true,
                mediaType: CallType.MEDIA_VEDIO
            };
            RongCallLib.call(params);
        };

        function reject(){
            RongCallLib.reject();
        }

        function join(){
            var params = {
                mediaType: CallType.MEDIA_VEDIO
            };
            RongCallLib.join(params);
        }

        function mute(){
            RongCallLib.mute();
        }

        function unmute(){
            RongCallLib.unmute();
        }

        function videoToAudio(){
            RongCallLib.videoToAudio();
        }

        function audioToVideo(){
            RongCallLib.audioToVideo();
        }

    </script>
</html> 