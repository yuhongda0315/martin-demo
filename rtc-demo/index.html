<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>RongRTC</title>
  <script src="本地路径/RongRTC.2.0.0.js"></script>
  <style>
    .rong-container{
      height: 400px;
      width: 100%;
      background-color: #000;
      margin: 0 auto;
    }
    .rong-toolbar{
      height: 50px;
      border-bottom: 1px solid #FFF;
      box-sizing: border-box;
      padding: 10px;
    }
    .rong-video-box{
      height: 80%;
    }
    .rong-input{
      outline: none;
      margin-left: 10px;
    }
    .rong-video-box video{
      height: 100px;
      width: 100px;
      margin: 20px;
      float: left;
      border: 1px solid #FFF;
    }
  </style>
</head>

<body>

  <div class="rong-container">
    <div class="rong-toolbar">
      <input class="rong-input rong-roomid" type="text" value="room9901">
      <input class="rong-input" type="button" value="Join" onclick="joinRoom()">
      <input class="rong-input" type="button" value="Leave" onclick="leaveRoom()">
      <input class="rong-input" type="button" value="GetStream" onclick="getStream()">
      <input class="rong-input" type="button" value="Mute" onclick="mute()">
      <input class="rong-input" type="button" value="Unmute" onclick="unmute()">
      <input class="rong-input" type="button" value="DisbaleVideo" onclick="disableVideo()">
      <input class="rong-input" type="button" value="EnableVideo" onclick="enableVideo()">
      <input class="rong-input" type="button" value="StartScreenshare" onclick="startScreenshare()">
      <input class="rong-input" type="button" value="StopScreenshare" onclick="stopScreenshare()">
      <input class="rong-input" type="button" value="createWB" onclick="createWhiteboard()">
      <input class="rong-input" type="button" value="getWBList" onclick="getWhiteboardList()">
      <input class="rong-input" type="button" value="getDeviceList" onclick="getDeviceList()">
      <input class="rong-input" type="button" value="checkDevice" onclick="checkDevice()">
      <input class="rong-input" type="button" value="setDevice" onclick="setDevice()">
    </div>
    <div class="rong-video-box"></div>
  </div>
  <script>
    let currentUser = {
      id: 'martin9901',
      token: 'sign=26e4ea1161b41a766405ab0edbdc5a86c7a4de08x4vkb1qpxfrzk1543287170000398fa&uid=martin9901'
    }
    let getDom = (key) => {
      return document.querySelector(key);
    };
    let videoBox = getDom('.rong-video-box');

    let rongRTC = new RongRTC();
    let { Room, Stream, ScreenShare, WhiteBoard, Device } = rongRTC;

    var rtcObserver = new rongRTC.Observer((mutation) => {
      console.log(mutation);
    });
    var rtcConfig = {
      error: true
    };
    rtcObserver.observe(rongRTC, rtcConfig);

    function joinRoom() {
      var id = getDom('.rong-roomid').value;
      var room = {
        id,
        user: currentUser
      };
      Room.join(room).then((user) => {
        console.log(user);
      }, error => {
        console.log(error);
      });
    }

    function leaveRoom() {
      Room.leave().then((user) => {
        videoBox.innerHTML = '';
      });
    }

    let roomConfig = {
      // 用户加入
      joined: true,
      // 用户离开
      leaved: true,
      // 用户角色变化
      changed: true
    };
    let roomObserver = new rongRTC.Observer((mutation) => {
      if (mutation.type == 'leaved') {
        let { user } = mutation;
        let videoNode = document.getElementById(user.id);
        if (videoNode) {
          videoBox.removeChild(videoNode);
        }
      }
    });
    roomObserver.observe(Room, roomConfig);

    let streamConfig = {
      added: true
    };
    let createVideo = (id, stream) => {
      let video = document.createElement('video');
      video.srcObject = stream;
      video.autoplay = true;
      video.id = id;
      return video;
    };
    let appendVideo = (mutation) => {
      let { stream, user } = mutation;
      let video = createVideo(user.id, mutation.stream);
      videoBox.appendChild(video);
    };
    let streamObserver = new rongRTC.Observer((mutation) => {
      if (mutation.type == 'added') {
        appendVideo(mutation);
      }
    });
    streamObserver.observe(Stream, streamConfig);

    function getStream() {
      Stream.get(currentUser).then(stream => {
        console.log(stream);
      });
    }

    function mute() {
      Stream.Audio.mute(currentUser);
    }

    function unmute() {
      Stream.Audio.mute(currentUser);
    }

    function disableVideo() {
      Stream.Video.disable(currentUser);
    }

    function enableVideo() {
      Stream.Video.enable(currentUser);
    }

    function startScreenshare() {
      ScreenShare.start().then(() => {
        console.log('share successfully.');
      }, error => {
        console.log(error)
      });
    }

    function stopScreenshare() {
      ScreenShare.stop();
    }

    function createWhiteboard() {
      WhiteBoard.create().then(whiteboard => {
        console.log(whiteboard);
      });
    }

    function getWhiteboardList() {
      WhiteBoard.getList().then(result => {
        console.log(result);
      });
    }
    function getDeviceList(){
      Device.getList().then(devices => {
        console.log(devices);
      });
    }

    function checkDevice(){
      Device.check().then(result => {
        console.log(result);
      });
    }

    function setDevice(){
      Device.getList().then(devices => {
        let { 
          input: { 
            video: videoInputDevices
          }
        } = devices;

        let device = {
          input: {
            video: videoInputDevices[0]
          }
        };
        Device.set(device).then(() => {
          console.log('Set Successfully');
        }, error => {
          console.log(error);
        });
      });
    }

  </script>
</body>

</html>