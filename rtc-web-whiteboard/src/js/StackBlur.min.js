function premultiplyAlpha(a){for(var t=a.data,e=a.width*a.height*4,r=0;e>r;r+=4){var n=t[r+3]/255;t[r]*=n,t[r+1]*=n,t[r+2]*=n}}function unpremultiplyAlpha(a){for(var t=a.data,e=a.width*a.height*4,r=0;e>r;r+=4){var n=t[r+3];0!=n&&(n=255/n,t[r]*=n,t[r+1]*=n,t[r+2]*=n)}}function stackBlurImage(a,t,e,r){var n=document.getElementById(a),l=n.naturalWidth,g=n.naturalHeight,c=document.getElementById(t);c.style.width=l+"px",c.style.height=g+"px",c.width=l,c.height=g;var o=c.getContext("2d");o.clearRect(0,0,l,g),o.drawImage(n,0,0),isNaN(e)||1>e||(r?stackBlurCanvasRGBA(t,0,0,l,g,e):stackBlurCanvasRGB(t,0,0,l,g,e))}function stackBlurCanvasRGBA(a,t,e,r,n,l){if(!(isNaN(l)||1>l)){l|=0;var g,c=document.getElementById(a),o=c.getContext("2d");try{try{g=o.getImageData(t,e,r,n)}catch(i){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),g=o.getImageData(t,e,r,n)}catch(i){throw alert("Cannot access local image"),new Error("unable to access local image data: "+i)}}}catch(i){throw alert("Cannot access image"),new Error("unable to access image data: "+i)}premultiplyAlpha(g);var s,u,h,b,m,f,d,v,x,B,w,p,y,I,C,k,E,R,A,D,N,_,S,G,P=g.data,M=l+l+1,U=r-1,H=n-1,W=l+1,j=W*(W+1)/2,q=new BlurStack,z=q;for(h=1;M>h;h++)if(z=z.next=new BlurStack,h==W)var F=z;z.next=q;var J=null,K=null;d=f=0;var L=mul_table[l],O=shg_table[l];for(u=0;n>u;u++){for(k=E=R=A=v=x=B=w=0,p=W*(D=P[f]),y=W*(N=P[f+1]),I=W*(_=P[f+2]),C=W*(S=P[f+3]),v+=j*D,x+=j*N,B+=j*_,w+=j*S,z=q,h=0;W>h;h++)z.r=D,z.g=N,z.b=_,z.a=S,z=z.next;for(h=1;W>h;h++)b=f+((h>U?U:h)<<2),v+=(z.r=D=P[b])*(G=W-h),x+=(z.g=N=P[b+1])*G,B+=(z.b=_=P[b+2])*G,w+=(z.a=S=P[b+3])*G,k+=D,E+=N,R+=_,A+=S,z=z.next;for(J=q,K=F,s=0;r>s;s++)P[f]=v*L>>O,P[f+1]=x*L>>O,P[f+2]=B*L>>O,P[f+3]=w*L>>O,v-=p,x-=y,B-=I,w-=C,p-=J.r,y-=J.g,I-=J.b,C-=J.a,b=d+((b=s+l+1)<U?b:U)<<2,k+=J.r=P[b],E+=J.g=P[b+1],R+=J.b=P[b+2],A+=J.a=P[b+3],v+=k,x+=E,B+=R,w+=A,J=J.next,p+=D=K.r,y+=N=K.g,I+=_=K.b,C+=S=K.a,k-=D,E-=N,R-=_,A-=S,K=K.next,f+=4;d+=r}for(s=0;r>s;s++){for(E=R=A=k=x=B=w=v=0,f=s<<2,p=W*(D=P[f]),y=W*(N=P[f+1]),I=W*(_=P[f+2]),C=W*(S=P[f+3]),v+=j*D,x+=j*N,B+=j*_,w+=j*S,z=q,h=0;W>h;h++)z.r=D,z.g=N,z.b=_,z.a=S,z=z.next;for(m=r,h=1;l>=h;h++)f=m+s<<2,v+=(z.r=D=P[f])*(G=W-h),x+=(z.g=N=P[f+1])*G,B+=(z.b=_=P[f+2])*G,w+=(z.a=S=P[f+3])*G,k+=D,E+=N,R+=_,A+=S,z=z.next,H>h&&(m+=r);for(f=s,J=q,K=F,u=0;n>u;u++)b=f<<2,P[b]=v*L>>O,P[b+1]=x*L>>O,P[b+2]=B*L>>O,P[b+3]=w*L>>O,v-=p,x-=y,B-=I,w-=C,p-=J.r,y-=J.g,I-=J.b,C-=J.a,b=s+((b=u+W)<H?b:H)*r<<2,v+=k+=J.r=P[b],x+=E+=J.g=P[b+1],B+=R+=J.b=P[b+2],w+=A+=J.a=P[b+3],J=J.next,p+=D=K.r,y+=N=K.g,I+=_=K.b,C+=S=K.a,k-=D,E-=N,R-=_,A-=S,K=K.next,f+=r}unpremultiplyAlpha(g),o.putImageData(g,t,e)}}function stackBlurCanvasRGB(a,t,e,r,n,l){if(!(isNaN(l)||1>l)){l|=0;var g,c=document.getElementById(a),o=c.getContext("2d");try{try{g=o.getImageData(t,e,r,n)}catch(i){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),g=o.getImageData(t,e,r,n)}catch(i){throw alert("Cannot access local image"),new Error("unable to access local image data: "+i)}}}catch(i){throw alert("Cannot access image"),new Error("unable to access image data: "+i)}var s,u,h,b,m,f,d,v,x,B,w,p,y,I,C,k,E,R,A,D,N=g.data,_=l+l+1,S=r-1,G=n-1,P=l+1,M=P*(P+1)/2,U=new BlurStack,H=U;for(h=1;_>h;h++)if(H=H.next=new BlurStack,h==P)var W=H;H.next=U;var j=null,q=null;d=f=0;var z=mul_table[l],F=shg_table[l];for(u=0;n>u;u++){for(I=C=k=v=x=B=0,w=P*(E=N[f]),p=P*(R=N[f+1]),y=P*(A=N[f+2]),v+=M*E,x+=M*R,B+=M*A,H=U,h=0;P>h;h++)H.r=E,H.g=R,H.b=A,H=H.next;for(h=1;P>h;h++)b=f+((h>S?S:h)<<2),v+=(H.r=E=N[b])*(D=P-h),x+=(H.g=R=N[b+1])*D,B+=(H.b=A=N[b+2])*D,I+=E,C+=R,k+=A,H=H.next;for(j=U,q=W,s=0;r>s;s++)N[f]=v*z>>F,N[f+1]=x*z>>F,N[f+2]=B*z>>F,v-=w,x-=p,B-=y,w-=j.r,p-=j.g,y-=j.b,b=d+((b=s+l+1)<S?b:S)<<2,I+=j.r=N[b],C+=j.g=N[b+1],k+=j.b=N[b+2],v+=I,x+=C,B+=k,j=j.next,w+=E=q.r,p+=R=q.g,y+=A=q.b,I-=E,C-=R,k-=A,q=q.next,f+=4;d+=r}for(s=0;r>s;s++){for(C=k=I=x=B=v=0,f=s<<2,w=P*(E=N[f]),p=P*(R=N[f+1]),y=P*(A=N[f+2]),v+=M*E,x+=M*R,B+=M*A,H=U,h=0;P>h;h++)H.r=E,H.g=R,H.b=A,H=H.next;for(m=r,h=1;l>=h;h++)f=m+s<<2,v+=(H.r=E=N[f])*(D=P-h),x+=(H.g=R=N[f+1])*D,B+=(H.b=A=N[f+2])*D,I+=E,C+=R,k+=A,H=H.next,G>h&&(m+=r);for(f=s,j=U,q=W,u=0;n>u;u++)b=f<<2,N[b]=v*z>>F,N[b+1]=x*z>>F,N[b+2]=B*z>>F,v-=w,x-=p,B-=y,w-=j.r,p-=j.g,y-=j.b,b=s+((b=u+P)<G?b:G)*r<<2,v+=I+=j.r=N[b],x+=C+=j.g=N[b+1],B+=k+=j.b=N[b+2],j=j.next,w+=E=q.r,p+=R=q.g,y+=A=q.b,I-=E,C-=R,k-=A,q=q.next,f+=r}o.putImageData(g,t,e)}}function BlurStack(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}var mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];